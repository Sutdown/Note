---

---

# 计算机网络5—传输层



### 知识点导引：

![180](F:\论文\Week\image\180.jpg)

![181](F:\论文\Week\image\181.jpg)

- 多路复用和多路分解是什么？——发送时一起发送，接收时再分解
- UDP是什么？——无连接，不可靠，常用于承载网络数据管理比如DNS
- 可靠数据传输原理有哪些？——流水线，回退N步（GBN），选择重传（SR）
- TCP的可靠传输是偏向GBN还是SR？——TCP是GBN和SR的混合体
- 解释一下拥塞控制原理。——

[TOC]



### 5.1 运输层概述

如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务，**运输层协议又称为端到端协议**。  

运输层直接为应用进程间的逻辑通信提供服务。 



### 5.2 运输层端口号，复用和分用的概念

##### 端口号

- 计算机上的进程使用进程标识符PID进行标志。
- 为了使得不同操作系统中的应用进程之间能进行网络通信，就必须使用统一的方法对TCP/IP体系的应用进程进行标识，也就是端口号。
- 端口号为16bit。
  - 熟知端口号：0-1023
  - 登记端口号：1024-49151
  - 短暂端口号：49152-65535
- 端口号只具有本地意义，**只是为了标识计算机应用层的各个进程**，不同计算机中相同的端口号没有联系。



##### 发送方的复用和接收方的分用

![8](E:\Sophomore\计网\image\8.png)

![9](E:\Sophomore\计网\image\9.png)



### 5.2.5 RDT可靠数据传输

#### 深入理解RDT

##### 应用场景

在有丢包，出错的不可靠情况下，需要可靠的数据传输（没有丢包，出错，乱序）的场景都可以考虑RDT。

##### 需要解决的问题

包出错，包丢失，包乱序

##### 可靠传输的解决方案

差错检测；ACK；出错重传；超时重传；序列号

其中，ACK，出错重传和超时重传都是**以延迟为代价换取可靠**

##### 性能评价

协议设计会影响端到端的性能，因此协议实现后要做性能评价确保协议性能。性能评价参数有：

- **最大链路利用率（maximum link utilization）**：理论分析时使用，即理想情况（无丢包，无差错，无乱序）下协议能够达到的链路利用率。（可靠传输的双方之间的逻辑链路）
- **端端有效吞吐率（goodput）**：接收端的有效吞吐率，接收端单位时间内正确收到的按需到达的数据量。



#### RDT协议的设计

以延迟（重传）为代价换取可靠性。

关键问题：降低延迟，提高链路利用率

##### 经典RDT协议

###### stop-and-wait

发送端每次只发送一个数据包，直到该数据包正确接收才发送下一个数据包。

###### pipelined RDT

发送端可以连续发送多个数据包，经典案例有**GBN回退n帧和SR选择重传**。

- GBN：累计确认，超时重传，不缓存乱序包

  若刚开始就出现差错会导致大量重传

- SR：定时器，超时重传，缓存乱序包，正确收到时返回ACK

  不适用包有问题或者乱序较多的情况



##### 根据延迟带宽积(bandwith*delay)选择RDT类别

<img src="F:\论文\Week\image\182.jpg" alt="182" style="zoom: 80%;" />



##### Pipelined RDT的滑动窗口(sliding window)技术

[计算机网络自顶向下 -- 流水线，滑动窗口协议_stop-and-wait versus pipelined protocol-CSDN博客](https://blog.csdn.net/qq_61039408/article/details/128987134?ops_request_misc=%7B%22request%5Fid%22%3A%22171844270516800185887809%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&request_id=171844270516800185887809&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-4-128987134-null-null.142^v100^pc_search_result_base4&utm_term=pipeline RDT滑动窗口&spm=1018.2226.3001.4187)

[计算机网络学习笔记13--可靠数据传输协议（流水线协议和滑动窗口协议）_流线协议-CSDN博客](https://blog.csdn.net/weixin_47734224/article/details/122689985?ops_request_misc=%7B%22request%5Fid%22%3A%22171844270516800185887809%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&request_id=171844270516800185887809&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-122689985-null-null.142^v100^pc_search_result_base4&utm_term=pipeline RDT滑动窗口&spm=1018.2226.3001.4187)

确定一个固定的窗口，若有超时的数据包，

先将前面收到的数据包移出窗口，

将该超时的数据包发送出去，同时在接收方窗口缓存之前包括超时在内乱序的数据包，

将超时后顺序的几个ACK发送回去，移动右边窗口
$$
N_S+N_R\leq 2^k
$$




#### 利用FSM(Finite State Machine)设计RDT协议

##### 经完全可靠信道的可靠数据传输：rdt1.0

<img src="F:\论文\Week\image\183.jpg" alt="183" style="zoom:80%;" />

$\frac{引起变迁的事件}{事件发生时采取的动作}$

receiver：从底层信道接收分组，取出数据再上传给较高层

sender：接受来自较高层的数据，将数据分组发送到信道中



##### 经具有比特差错信道的可靠数据传输：rdt2.0

对于比特差错的常用解决方法是ARQ协议(Automatic Repeat reQuest)

ARQ还需要另外三种协议处理存在比特差错的情况

- 差错检测
- 接收方反馈
- 重传



##### 经具有比特差错的丢包信道的可靠数据传输：rdt3.0

![184](F:\论文\Week\image\184.jpg)

**rdt3.0 receiver**

![185](F:\论文\Week\image\185.jpg)

两个FSM见图，不讲解。

主要：比特受损和丢包



#### 性能评价

![186](F:\论文\Week\image\186.jpg)



### 5.3 UDP和TCP

##### UDP(User Datagram Protocol)

- 面向报文
- 无连接，不可靠的传输服务

##### TCP(Transmission Control Protocol)

- 流水线可靠传输机制
- 动态设置超时间隔
- 捎带应答
- 累积应答
- 快速重传
- 单一计时器

![10](E:\Sophomore\计网\image\10.png)



### 5.4 TCP的流量控制

flow control

- 让发送方的发送速率不要太快，要让接收方来得及接收
  - 由于互联网接入设备的多样性，导致接入设备的处理能力不同。TCP发送端的数据包经过网络传输到达接收端后，由于发送速度快接收数据慢缓冲区满导致的丢包。
  - 在数据包包头增加接收端可用缓冲区大小，控制发送端的发送速率。
- 利用**滑动窗口机制**可以很方便的在TCP连接上实现对发送方的流量控制

![11](E:\Sophomore\计网\image\11.png)

持续计时器的成因

![12](E:\Sophomore\计网\image\12.png)

持续计时器的过程

**发送方会发送零窗口探测报文段，以打破死锁局面。**



### 5.5 TCP的拥塞控制

> **问题**：由于互联网端系统业务的突发性，TCP发送端的发送速率较大，短时间向网络注入大量数据包，核心网络中的路由器不能及时转发出去而导致丢包。
>
> **解决方案**：调整发送端速率。

##### congestion

- 对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏，这就叫做拥塞。

##### 判定方法：

- 三次重复ACK
- 超时



##### 四种拥塞控制算法

前提条件假设：

1.数据单方向传送，另一个方向只传送确认

2.接收方有足够大的缓存空间，因此发送方窗口大小由网络拥塞程度决定

3.以最大报文段MSS的个数为讨论问题的单位，而不是字节。

- 拥塞窗口cwnd的维护原则：只要网络没有出现拥塞，拥塞窗口就增大一点，网络出现拥塞，拥塞窗口就减少一些。
- 判断出现网络拥塞的依据：没有按时受到应当到达的确认报文（超时重传）。

算法：

- slow-start

- congestion avoidance

  ![13](E:\Sophomore\计网\image\13.png)

  当个别报文段在网络中丢失时，网络并未发生拥塞，这导致发送方超时重传，并误认为网络发生了拥塞，发送方将拥塞窗口cwnd设置为最小值1，错误的启动慢开始算法，降低传输效率。

  快重传可以让发送方尽早知到发生个别报文段的丢失。

- fast retransmit

  - 使发送方尽快重传，而不是等超时重传计时器超时再重传。
  - 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认。
  - 收到失序的报文段也要立即发出对收到报文段的重复确认。
  - 一旦发送方收到三个连续的重复确认，就将相应报文段立即重传。

- fast recovery

  - 收到三个重复确认后，就知道丢失了个别报文段，执行快回复算法
  - 发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半；开始执行拥塞避免算法
  - 也有的增大cwnd，也就是ssthresh+3。

![14](E:\Sophomore\计网\image\14.png) 



### 5.6 TCP超时重传时间的选择

- 超时重传时间RTO应略大于往返时间RTT

  - 不能直接利用某次的RTT样本计算超时重传时间RTO
  - 利用每次测量的RTT样本，计算加权平均往返时间$RTT_S$

- RFC6298建议使用下式计算超时重传时间RTO：$RTO=RTT_S+4RTT_D$

  $RTT_D$：RTT偏差的加权平均

- 针对**出现超时重传时无法测准往返时间RTT**的问题，KARN提出算法：计算加权平均往返时间时，报文重传的话，就不采用其往返时间样本。但如果时延增大，就会反复重传。

- 因此对Karn算法修正：**报文段每重传一次，就把超时重传时间RTO增大一些**，可以将新RTO值取为旧的RTO值的两倍。

<img src="F:\论文\Week\image\187.jpg" alt="187" style="zoom:80%;" />



### 5.7 TCP可靠传输的实现

- TCP基于以字节为单位的滑动窗口来实现可靠传输

![15](E:\Sophomore\计网\image\15.png)



### 5.8 TCP的运输连接管理

1. 建立连接
2. 数据传送
3. 释放TCP连接

#### TCP的连接建立——“ TCP 3-way handshake”

连接建立需要解决的问题：

- 使TCP双方能够确知对方的存在
- 使TCP双方能够协商一些参数
- 使TCP双方能够对运输实体资源进行分配

三次握手：为了解决连接过程出现的丢包乱序问题。

![16](E:\Sophomore\计网\image\16.png)



#### TCP的连接释放

TCP双向数据传输，两边需要分别终止该方向上的数据传输。

![17](E:\Sophomore\计网\image\17.png)

- TCP服务器进程每收到一次TCP客户进程的数据，就重新设置并启动保活计时器
- 若**保活计时器定时周期内未收到TCP客服进程发来的数据**，则当保活计时器到时后，TCP服务器进程就像TCP客户进程发送探测报文段，每隔75秒发送一次，**一连发送十个仍无响应就认为TCP客户进程所在主机出故障然后关闭连接**。

##### 注：

TCP建立连接**本质上要为数据包的双向包的双向可靠传输预约资源**，包括TCP client和server缓冲区的分配，各种变量的初始化。TCP建立连接后才开始**数据传输，流量控制和拥塞控制**。



### 5.9 TCP报文段的首部格式

- 面向字节流

<img src="E:\Sophomore\计网\image\18.png" alt="18" style="zoom: 45%;" />
