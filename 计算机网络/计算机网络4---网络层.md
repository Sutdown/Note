## 计算机网络——网络层

[计算机网络（自顶向下方法）学习笔记_计算机网络自顶向下方法学习-CSDN博客](https://blog.csdn.net/qq_39326472/article/details/88089747?ops_request_misc=%7B%22request%5Fid%22%3A%22171845674216800178595916%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&request_id=171845674216800178595916&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-6-88089747-null-null.142^v100^pc_search_result_base4&utm_term=计网自顶而下网络层&spm=1018.2226.3001.4187)

[TOC]



### 4.1网络层在协议栈中的位置，功能，服务

网络层在协议栈的中心位置，向上层提供尽力而为的网络服务，统一了下层不同物理网络的异构型。

**主要功能**：转发和路由。实现网络互连，实现数据包在网络之间的传播。

**待解决问题：**

- 网络层向运输层提供的服务
- 网络层的寻址
- 路由选择问题

#### 4.1.1理解网络层在协议栈中位置的重要性

<img src="F:\论文\Week\image\189.jpg" alt="189" style="zoom:80%;" />

##### 从网络架构上看

网络层在端系统设备（主机，服务器等）和核心网络设备（路由器）上都有实现。

核心网络的主要功能是数据包转发和路由。

核心网络是由路由器互联构成的，因此**转发和路由**也是路由器的主要功能。

##### 从网络协议栈角度

端系统上运行了五层协议，而路由器上原则上只运行三层协议（网络层，链路层，物理层）。

网络层对上层屏蔽了底层的差异性。底层（数据链路层和物理层）涉及到不同的通信技术，比如以太网，WLAN，蓝牙等。这些通信网络通常**传输介质**不同，**信道共享的方式（**链路层）也不同。但是在网络层都统一起来了，都支持**IP数据包格式**，为上层传输层提供了一个统一接口。

这种设计和实现方式使得Internet能够不断支持新的通信技术。



#### 4.1.2网络层的主要功能：转发和路由

<img src="F:\论文\Week\image\188.jpg" alt="188" style="zoom:80%;" />

（接收上层的信息，给下层发送信息）

##### 转发和路由

<img src="F:\论文\Week\image\190.jpg" alt="190" style="zoom:80%;" />



### 4.2了解路由器的内部结构

- 路由器是专用的网络设备。数据包转发是它的核心功能。

- 转发速率是衡量路由器性能的重要指标。

- 数据包的排队和丢包发生在output port。

#### 概念

分组交换机，链路层交换机，路由器

#### 路由器体系结构

<img src="F:\论文\Week\image\191.jpg" alt="191" style="zoom:80%;" />

##### 四个组件

###### 输入端口

路由器使用转发表找到输出端口，使得到达的分组能经过交换结构转发到该输出端口。

###### 交换结构

将输入结构连接到输出结构，路由器网络中的网络。

- 经内存交换
- 经总线交换
- 经互联网络交换

##### 输出端口

输入和输出端口都可能出现分组队列，当没有内存处理时会发生丢包。

###### 路由选择处理器

执行控制平面功能。

在传统路由器中执行路由选择协议，为路由选择表和关联链路状态信息，为该路由器计算转发表。

SDN路由器中，负责和远程控制器通信，目的接收远程控制器计算的转发表项，在输入端口安装这些表项。

##### 分组队列的排队方法：类似于操作系统？？

### 4.3IP地址的分配方法



#### 4.3.1 IPV4的数据包的数据包格式

选择其中一部分：

- 寿命：（Time-to live）：TTL，确保数据包永不不会在网络中循环。



#### 4.3.2 IP地址的分配方法

##### 4.3.1IP地址的表示方法

<img src="F:\论文\Week\image\192.jpg" alt="192" style="zoom:80%;" />

##### 4.3.2子网中主机号的分配原则

<img src="F:\论文\Week\image\193.jpg" alt="193" style="zoom:100%;" />

###### RFC3021中规定

点对点链路（比如两个路由器）组成的子网中，主机号可以是全0或者全1。

普通子网的主机号不可以使用全0和全1，

全0代表本机，全1代表子网内广播地址。

若主机号位数为n，最大支持主机个数为$2^n-1$。

###### 注意：

1. 子网分配的IP地址要连续
2. 路由器的每个端口都要连接一个子网
   - 每个端口所在子网不同
   - 每个端口都要分配一个IP地址。该IP地址在子网地址范围内



#### 4.3.3路由器转发表：IP地址最长匹配原则

路由目的地址最长匹配原则：路由器收到一个数据包后，使用其目的IP地址查找转发表，选择最长匹配的表项。



### 4.4DHCP和NAT工作原理

#### DHCP，dynamic host configuration protocol

**作用**：

- 通过DHCP自动获取网络配置信息。允许一台计算机加入新网络时可**自动获取IP地址等网络配置信息不用手工参与**。
- 允许设备动态的获取IP地址，而不是静态的指定每台主机地址。
- 能够分配配置参数，客户端用一个消息能获取所有的配置信息。
- 是一种C/S模式的网络协议。



**DHCP工作过程**：

封装给有DHCP报文的UDP用户数据报，在网络层封装成IP数据报。封装报文内部有事物ID和客户端的MAC地址。

![](E:\Sophomore\计网\image\5.png)

##### 主要报文：

- DHCP DISCOVER
- DHCP NACK
- DHCP OFFER
- DHCP ACK
- DHCP RELEASE



##### DHCP在运输层使用UDP协议封装

- DHCP客户端使用UDP端口号为68
- DHCP服务器UDP端口号为67



##### DHCP在未获取到IP地址时使用地址0.0.0.0

- 每个网络中至少有一个DHCP中继代理，通常hi一台路由器，配置了DHCP服务器的IP地址信息，作为网络中计算机与DHCP服务器桥梁。



#### NAT

缓解IPV4地址空间即将耗尽的问题

使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源

- 需要关联表保存信息
- NAT路由器的存在公开透明
- 网络访问只能由私网侧发起，公网无法主动访问私网主机

端口复用技术：NAPT

<img src="F:\论文\Week\image\194.jpg" alt="194" style="zoom:80%;" />

### 4.5路由协议设计的基本思想和方法

> 网络范围的路由选择控制平面是**分布式**的，即不同部分（如路由选择算法）执行在不同的路由器上，并且通过**彼此发送控制报文进行交互**。

网络层的三个组件

<img src="F:\论文\Week\image\194.jpg" alt="194" style="zoom:80%;" />

#### IP协议

##### 数据报格式

<img src="F:\论文\Week\image\196.jpg" alt="196" style="zoom:67%;" />

- 可以是IPV4也可以是IPV6，但是对部分内容的解释不同
- TTL：确保数据包不会再网络中循环
- 协议号：指示对应的运输层协议 6对应TCP；17对应UDP
  - 协议号：网络层和运输层
  - 端口号：运输层和应用层
- IPV6没有选项字段

1. IP数据报分片

   当IP长度大于MTU（最大传输单元），IP数据报需要在端系统分片，到达目的主机(端系统)后重组，只有重组成功才会传给传输层，否则不完整的数据报会进行丢失重传。

##### IP广播地址

当一台主机发出目的地址为**255.255.255.255**的数据报时，报文会交付给同一个网络的所有主机，路由器也会有选择的向邻近的子网发送报文（通常不这样做）。可用于DHCP发现报文的发送，广播最小生成树。



#### 路由选择协议

DHCP和NAT

##### DNS

能够解析IPV4和IPV6地址。

##### IPV4和IPV6

如果发送方和接收方中任意一个仅为IPV4使能的，则必须使用IPv4数据报。

<img src="F:\论文\Week\image\197.jpg" alt="197" style="zoom:80%;" />

结点B必须生成一个IPv4数据报发给C，IPv6数据报的数据字段可以复制到IPv4数据报的数据字段中，并且要做适当的映射。在IPv4中没有对应的部分的数据，这些字段的信息会丢失

**建隧道tunneling**：图中B和E，要使用IPV6交互，但是它们经由中间IPv4路由器关联的，我们将**两台IPv6路由器之间的Ipv4路由器的集合成为一个隧道**，将整个IPv6数据报放在IPv4的有效载荷中。



#### 控制报文协议ICMP

> internet control message protocol：
>
> 报告数据中的差错比如差错报告，对某些网络层信息请求进行响应的设施。

当发生`目的网络不可到达`这种错误，IP路由器找不到路径通往指定主机，路由器就向发送主机发出ICMP报文指示错误。

- **ping**：发送一个ICMP类型8编码0（回显请求）的报文到指定主机，目的主机发回一个类型0编码0（回显回答）的报文

-   **源抑制报文**：拥塞的路由器向主机发送，强制主机减小发送速率。TCP在运输层有拥塞控制机制，不需要该报文的信息了

###### Traceroute：如何跟踪从一台主机到世界上任意一台主机之间的路由？

**原理**：IP协议规定，路由器收到TTL为0的数据报会将其丢弃，然后发送一个ICMP告警报文给源主机，which concludes the name and IP address of it
 **方法**：发送TTL为1~n的一系列IP数据报。当到达目的主机时，返回一个端口不可达（数据报携带了不可达UDP端口号）的ICMP报文，则结束探测

[ICMP协议详解-CSDN博客](https://blog.csdn.net/baidu_37964071/article/details/80514340)

ICMP协议的功能主要有：

1. 确认IP包是否成功到达目标地址
2. 通知在发送过程中IP包被丢弃的原因

### 4.6LS Dijkstra和DV路由算法

##### Dijkstra算法

属于LS（Link state）路由选择算法，全局式路由选择算法。

- 每次增加前一次中具有最低开销的结点。
- 转发表：通过对每个目的节点存放u到目的地的最低开销路径的下一跳结点。



##### DV路由算法（distance vector)

分散式路由选择算法。

只知道自己和邻居节点之间的距离。

第一列，自己到其它结点距离

第二列，把自己的表格的哪一行给相邻结点

如果没有改变，下次就不用给。

### 4.7理解层次型路由协议的工作原理，了解经典路由协议

#### 层次路由选择

当路由器数目变得很大，算法开销高的不可实现比如LS更新链路费用管理自治，一个组织应该按照自己愿望运行管理其网络。

**解决方案：**将路由器组织进自治系统AS；

##### AS

- 每个IS由一组相同管理控制的路由器组成，比如相同的ISP运行运行下
- 相同AS中路由器全部运行同样的路由选择算法，叫做**自治系统内部路由选择协议**。
- 因特网中所有AS都运行相同的**AS间路由选择协议BGP4**
- 每台路由器同时运行来自以上两种协议的信息，同时利用这些信息**配置转发表**。

>  某AS非网关路由器对转发表增加用于子网x（该AS外）的表项采取的动作：
>
> 1. 从AS间协议知道经多个网关可达子网x
>
> 2. 使用AS内部协议的路由选择信息，决定到每个网关的最低费用路径的费用
>
>    热土豆路由选择：选择具有最小的最低费用的网关
>
> 3.  从转发表确定最低费用网关接口I，将（x,I）添加到转发表中
>
> 4.  如果AS从一个相邻AS处知道一个目的地，该AS能向它某些其他相邻AS通告该路由选择信息
>
>     一个ISP可能分为多个互联的AS



#### 因特网中的路由选择

**AS内部路由选择协议**，又称内部网关协议，

路由选择信息协议RIP，通常设置在下层ISP中

开放最短优先OSPF，通常设置在上层ISP中

##### AS内部路由选择协议：RIP（DV思想）

![33](E:\Sophomore\计网\image\0\33.png)

1. > 使用**跳数**作为其费用测度
   >
   > **跳**：沿着源路由器到目的子网（包括）的最短路径经过的子网数量

   一条路径的最大费用限制为15，因此RIP使用限制在网络直径不超过15跳的自治系统内
     路由选择更新，信息在邻居之间通过使用**RIP响应报文（RIP通告**）来交换，大约每30s交换一次。

   一台路由器或主机发出的响应报文包含了该AS内多达25个目的子网的列表，以及发送方到每个子网的距离.

2. 每台路由器维护一张称为**路由选择表的RIP表**，包括该路由器的**距离向量和转发表**（目的子网，下一台路由器，到目的地跳数）

   路由器收到通告后，将通告与路由选择表合并，记下更短路径（DV算法还在收敛，或者新的链路加入AS）

3. > **一台路由器超过180s没有从邻居听到报文，该邻居要么死记要么链路中断**.

   RIP可以修改本地路由选择表，向活着的邻居发送RIP通告，也可以使用RIP请求报文请求邻居到目的地的费用

4. RIP被当做一个**应用**进程来实现，能在一个标准socket上发送个接收报文，并且使用一个标准的运输层协议,路由器在**UDP**上用端口520相互发送RIP请求/响应报文。意思是RIP使用一个运输层协议实现网络层功能



##### AS内部路由选择协议：OSPF（LS思想）

OSPF和其兄弟IS-IS通常设置在上层ISP中，RIP在下层ISP和企业网中

> OSPF核心：使用洪泛链路状态信息的**LS**协议 + **Dijkstra最低费用路径算法**。**各条链路费用（权值）是管理员配置的**

- 使用OSPF，一台路由器构建了整个AS的拓扑图，然后在本地运行Dijkstra算法
- 使用OSPF，路由器向AS内所有其他路由器**广播路由选择信息**。即使链路未发生变化，也要周期性广播链路状态（at least 30 minutes at a time）

 OSPF报文由IP直接承载。

######  优点：

-  安全：能够鉴别OSPF路由器之间的交换，仅有受信任的路由器能参与AS内的OSPF协议。包括使用MD5加密

- 多条相同费用路径：无需仅选择单一路径承载所有流量

- 支持单播多播路由选择

- 支持在单个路由选择域内的层次结构：具有按层次结构构造一个自治系统的能力

- 一个OSPF AS可以配置成多个区域，每个区域运行自己的OSPF LS算法，一个区域内每台路由器可以向该区域其他路由器广播链路状态

  > 一个区域内，一台或多台区域边界路由器负责为流向该区域以外的分组提供路由选择
  >
  > AS内只有一个OSPF区域配置成主干区域，为其他区域之间的流量提供路由选择。该主干包含AS内所有区域边界路由器，也可能包含一些非边界路由器
  >
  > 某区域内分组—》区域边界路由器—》主干—》目的区域边界路由器—》目的地



##### AS间的路由选择协议：BGP

###### BGP：边界网关协议

跨越多个AS的源和目的对之间确定路径，现在用的BGP4

###### BGP为AS提供：

​        从相邻AS获得子网可达性信息
​        向本AS内部所有路由器传播这些可达性信息
​        基于可达性信息和AS策略，决定到达子网的路由
BGP使得每个子网向因特网其余部分通告它的存在：一个子网高声宣布『在这！』，并且确保因特网中所有AS知道该子网以及如何到达

   1. ###### BGP基础
      
        是因特网中至关重要的协议，正是BGP将一切『粘合』起来
        BGP中，路由器通过使用**179端口的半永久TCP**连接来交换路由信息
        
        跨越两个 AS的TCP连接称为外部BGP会话eBGP，AS内部每对路由器之间的TCP连接成为内部BGP会话iBGP，iBGP并不总与物理链路对应，位于连接两端的两台路由器成为**BGP对等方**。
        
        > 假设你开了公司，与ISP签订协议，获得了一个IP地址范围（子网），每台路由器是通过BGP知道你公司地址的前缀进行转发的，这样别人才能成功将分组发到公司
        > BGP使每个AS知道经过其相邻AS可到达哪些目的地子网，
        >
        > 目的地是CDIR化的前缀，子网或子网的集合；
        
        BGP中，一个AS由其全局唯一的AS号ASN标识，which is allocated by ICANN
        
        当一台路由器通过BGP会话通告一个前缀时，它在前缀中包括一些属性。带属性的前缀称为一条路由，BGP对等方彼此通告路由。
        
        - **AS-PATH：**该属性包含了前缀通告已经通过的AS，当一个前缀传送到一个AS时，AS将其ASN增加到AS-PATH中
        
          路由器使用AS-PATH属性检测和防止循环通告
        
          路由器使用AS-PATH在多条路径中选择相同的前缀
        
        - **NEXT-HOP**：是一个开始某AS-PATH的路由器接口
        
          路由器使用该属性正确地配置它们的转发表
        
          使用NEXT-HOP值和AS内部路由选择算法，路由器能确定到每条对等链路的路径的费用，用热土豆路由选择决定适当的接口
        
        - BGP路由选择
        
          BGP使用eBGP和iBGP向在AS中的所有路由器发布路由，路由器可能知道到达任何一条前缀的多条路由。
        
          > 消除规则从上到下：
          >
          > - 选择具有最高本地偏好值（管理员决定）的路由
          >
          > - 选择具有最短AS-PATH的路由
          >
          > - 最靠近NEXT-HOP路由器的路由，最靠近指最低费用路径最低，由AS内部算法决定（hot potato routing）
          >
          >   使用BGP标识符选择路由
          >
          >   路由选择策略：反应ISP之间商业关系



#### 广播和多播路由选择

在**广播路由选择**（必须同一网段)中，网络提供了一种源节点到网络中事务所有其它结点的交付分组的服务；多播路由选择使单个源节点能够向其他网络结点的一个子集发送分组的副本。（不必同一网段).

##### 广播路由选择算法

###### 1.N次单播

给定N个目的节点，源结点产生该分组的N份副本，对不同目的地每个副本编址，用单播路由选择传送，但是效率低，**多份独立的副本会重复经过某段链路**，让网络结点本身生成分组副本更有效。

N**次单播的一个假设是广播的接收方及其地址为发送方所知晓**。

但是怎样得到这些消息呢？最可能的是，可能还需要别的机制。浙江增加更多的开销。

###### 2.无控制洪泛

- 源节点向所有邻居发送分组副本，结点复制该分组并向它邻居转发，**如果图中有环，会无休止循环。**
- 当一个结点与两个以上结点连接时，它将生成并转发广播分组的多个副本，副本中的每个又产生多个副本，产生**广播风暴**，使网络变得毫无用处

###### 3.受控洪泛

**序号控制洪泛**：

源节点将其地址或其他唯一标识和广播序号放入广播分组，每个结点维护它已经收到的、复制的和转发的源地址和序号列表。当结点接受到一个广播分组时，它首先检查该分组是否在列表中。如果在，丢弃该分组；如果不在，复制该分组并向该结点的所有邻居转发。

**反向路径转发RPF：**

仅当分组到达的链路正好位于它自己返回源的最短单薄路径上，才传输报文，否则丢弃。RPF仅需要知道在它到发送方的单薄路径上的下一个邻居；它仅用这个邻居的身份以决定是否洪泛一个接收到的广播分组。

###### 4.生成树广播

虽然序号控制洪泛和RPF避免了广播风暴，但它们不能完全避免冗余广播分组的传输。

构造最小生成树；结点只需知道哪些邻居在生成树中

**分布式生成树算法**

**基于中心的方法：**建立一棵生成树时，定义一个中心结点（汇合点、核），结点向中心结点单薄加入树的报文。加入树的报文使用单播路由选择朝着中心结点进发，直到它到达一个生成树中，经过的路径再嫁接到现有生成树中。

在实践中，广播协议被用于应用层和网络层

##### 多播

只有一部分路由器（那些具有加入该多播组的相连主机的路由器）实际需要接收多播流量。

一些新兴应用要求将分组从一个或多个发送方交付给一组接收方，比如各种直播、游戏多播数据报使用间接地址来编址。每个分组难道携带所有接收方IP地址？这不科学用一个标识表示一组接收方（D类多播地址），接收方小组称为多播组

###### 因特网组管理协议IGMP

IGMP + 多播路由选择协议 组成网络层多播

**确定多播路由选择：**

- 使用一棵组共享树的多播路由选择（共享的）：通过组共享树进行多播路由选择的基础是构建一棵树。


- 使用一棵基于源的树的多播路由选择：而第二种方法为多播组中的每个源构建一棵多播路由选择树。


解决应用RPF时会收到不想要的多播分组这个问题成为剪枝。一台接收到该多播分组的多播路由器，如它无加入改组的相连主机，则它向其上游路由器发送一个剪枝报文，则它就能向上游转发一个剪枝报文。

### 网络层提供的两种服务

##### 面向连接的虚电路服务

##### 无连接的数据报服务

![31](E:\Sophomore\计网\image\0\31.png)

##### IPV4地址

![32](E:\Sophomore\计网\image\0\32.png)

路由静态配置，路由环路等



### VPN and NAT

vpn：

同一机构内不同部门的内部网络所构成的虚拟专用网VPN又称为**内联网VPN**

一个机构的vpn需要外部机构参加进来，这就被称为**外联网vpn**

NAT：

缓解IPV4地址空间即将耗尽的问题

使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源

[NAT — 网络地址转换科普_](https://www.bilibili.com/video/BV17W411d7aQ/?spm_id_from=333.337.search-card.all.click&vd_source=658588b117b821559d189ce730ded61c)

[NAT网络地址转换知识](https://www.bilibili.com/video/BV1K94y1U7VT/?spm_id_from=333.337.search-card.all.click)

[DHCP运作原理和握手过程_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1Gd4y1n7Xz/?spm_id_from=333.337.search-card.all.click&vd_source=658588b117b821559d189ce730ded61c)
